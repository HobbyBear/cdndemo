
>  è¿™ä¸€ç”Ÿå¬è¿‡è®¸å¤šé“ç†ï¼Œä½†è¿˜æ˜¯è¿‡ä¸å¥½è¿™ä¸€ç”Ÿï¼Œè¿™æ˜¯å› ä¸ºç¼ºå°‘çœŸæ­£çš„åŠ¨æ‰‹å®è·µï¼Œå…‰å¬é“ç†ï¼Œç¼ºå°‘åŠ¨æ‰‹å®è·µçš„è¿‡ç¨‹ï¼Œå­¦ä¹ éš¾å…ä¼šè®©äººè§‰å¾—å‘³åŒåš¼èœ¡ï¼Œæ‰€ä»¥æˆ‘çš„åˆ†äº«éƒ½æ¯”è¾ƒå€¾å‘äºå®è·µï¼Œåœ¨ä¸€æ¬¡æ¬¡åŠ¨æ‰‹å®è·µçš„è¿‡ç¨‹ä¸­æ„Ÿå—çŸ¥è¯†åŸæœ¬çº¯çœŸçš„æ¨¡æ ·ã€‚

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯è“èƒ–å­ï¼Œå¾€å¾€ä»äº‹äº’è”ç½‘å¼€å‘çš„åŒå­¦éƒ½å¬è¿‡cdnè¿™ä¸ªè¯ï¼Œä¸è¿‡å¯¹äºåˆšå…¥è¡Œçš„åŒå­¦å¯èƒ½ä¼šå¯¹è¿™ä¸ªæ¦‚å¿µæ¯”è¾ƒæ¨¡ç³Šï¼Œä»Šå¤©æˆ‘ä»¬å°±æ¥èŠèŠå®ƒï¼Œå¹¶ä¸”æˆ‘ä¼šåœ¨åŸç†çš„åŸºç¡€ä¸Šåœ¨æœ¬åœ°æ­å»ºä¸€ä¸ªcdnç¯å¢ƒï¼Œæ¨¡æ‹ŸåŸŸåé…ç½®ï¼Œå›æºï¼Œä»¥åŠç¼“å­˜çš„è¿‡ç¨‹ã€‚

æœ¬èŠ‚æºç å·²ç»ä¸Šä¼ åˆ°github
```shell
https://github.com/HobbyBear/cdndemo
```

ç°åœ¨ï¼Œè®©æˆ‘ä»¬å¼€å§‹å§ã€‚

## cdnåŸç†ä»‹ç»

é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ä¸ºä»€ä¹ˆè¦ç”¨cdnï¼Œæ¯”å¦‚ä¸€ä¸ªä¸“æ³¨åšè§†é¢‘æ’­æ”¾æˆ–è€…å›¾ç‰‡é˜…è§ˆçš„ç½‘ç«™ï¼Œå½“ç”¨æˆ·æµè§ˆç½‘ç«™æ—¶ï¼Œéœ€è¦ä»ç½‘ç«™æ‹‰å–å›¾ç‰‡æˆ–è€…è§†é¢‘èµ„æºï¼Œè¿™å°†äº§ç”Ÿæµé‡è´¹ç”¨ï¼Œå¹¶ä¸”ï¼Œå¦‚æœç”¨æˆ·é‡Œç½‘ç«™æœåŠ¡å™¨è¶Šè¿œï¼Œäº§ç”Ÿçš„æµé‡è´¹ç”¨å°†è¶Šé«˜ã€‚è€Œcdnçš„åŸç†åˆ™æ˜¯å°†è§†é¢‘æˆ–è€…å›¾ç‰‡èµ„æºç¼“å­˜åœ¨ç¦»ç”¨æˆ·æ¯”è¾ƒè¿‘çš„æœåŠ¡å™¨ä¸Šï¼Œè¿™æ ·æ—¢æå‡äº†å“åº”é€Ÿç‡ï¼ŒåˆèŠ‚çº¦äº†æµé‡è´¹ã€‚

æ¥çœ‹ä¸‹ä½¿ç”¨cdnåï¼Œç”¨æˆ·è®¿é—®ç½‘ç«™çš„è¿‡ç¨‹ã€‚

![img.png](https://s2.loli.net/2023/06/16/5gAeH1yiUG7aVWI.png)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå‡è®¾ç”¨æˆ·è‡ªå·±çš„æƒ³è¦åŠ é€Ÿçš„åŸŸåæ˜¯web.cdn.testï¼Œå¦‚æœç”¨æˆ·æƒ³å¯¹è¿™ä¸ªåŸŸåè¿›è¡ŒåŠ é€Ÿï¼Œé¦–å…ˆè¦å»cdnæœåŠ¡å•†é‚£é‡Œé…ç½®ä¸Šè¿™ä¸ª**åŠ é€ŸåŸŸå**å’Œ**æºç«™æœåŠ¡åœ°å€**ï¼Œæ¥ç€cdnæœåŠ¡å•†ä¼šç”Ÿæˆä¸€ä¸ªåŸŸååœ°å€,è¿™é‡Œå‡è®¾ä¸ºweb.cdn.test.c.lanpangziï¼Œè€Œç”¨æˆ·è‡ªå·±éœ€è¦å»è‡ªå·±çš„dnsæœåŠ¡å•†é‚£é‡Œå°†åŠ é€ŸåŸŸåweb.cdn.test æŒ‡å‘è¿™ä¸ªæ–°çš„åŸŸååœ°å€ï¼Œè¿™ç§å°†ä¸€ä¸ªåŸŸåæŒ‡å‘å¦ä¸€ä¸ªåŸŸåçš„è®°å½•è¢«ç§°ä½œ**cname**è®°å½•ã€‚

ç»è¿‡ä¸Šè¿°æ­¥éª¤åï¼Œå¯¹åŸŸåweb.cdn.testçš„è®¿é—®ä¼šè¢«æŒ‡å‘web.cdn.test.c.lanpangzi,ä½†ç›®å‰è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæ–°çš„åŸŸåweb.cdn.test.c.lanpangziåº”è¯¥ç”±cdnæœåŠ¡å•†è‡ªå·±çš„dnsè°ƒåº¦ç³»ç»Ÿå»è§£æï¼Œè¿™æ ·cdnæœåŠ¡å•†æ‰èƒ½å°†è¾¹ç¼˜èŠ‚ç‚¹çš„ipè¿”å›ç»™ç”¨æˆ·ï¼Œé‚£æœ¬åœ°dnsæœåŠ¡å™¨æ€ä¹ˆçŸ¥é“web.cdn.test.c.lanpangziè¿™ä¸ªåŸŸåè¦äº¤ç»™å“ªå°æœºå™¨å»è§£æå‘¢ï¼Ÿ

åŸå› æ˜¯è¿™æ ·çš„ï¼ŒcdnæœåŠ¡å•†åœ¨æ³¨å†Œè‡ªå·±çš„ä¸»åŸŸåæ—¶(è¿™é‡Œçš„ä¸»åŸŸåæ˜¯langpangzi.) ï¼Œå‘dnsæœåŠ¡å™¨æ³¨å†Œäº†ä¸€æ¡**ns**è®°å½•ï¼Œnsè®°å½•å¯ä»¥æŒ‡å®šå°†æŸä¸ªåŸŸåçš„è§£æäº¤ç»™å“ªä¸€å°dnsæœåŠ¡å™¨è§£æï¼Œæ¯”å¦‚è¿™é‡Œï¼ŒcdnæœåŠ¡å•†å°±æŠŠ**c.langpangzi.** åŸŸåçš„è§£ææŒ‡å‘äº†cdnæœåŠ¡å•†è‡ªå·±çš„dnsæœåŠ¡å™¨ã€‚

å®Œæˆäº†è¿™ä¸€æ­¥ï¼Œç”¨æˆ·è‡ªå·±çš„åŠ é€ŸåŸŸåæœ€ç»ˆå°±ä¼šè¢«cdnæœåŠ¡å•†çš„dnsæœåŠ¡å™¨å»è§£æäº†ï¼ŒcdnæœåŠ¡å•†ä¸€èˆ¬åœ¨å…¨çƒå„åœ°éƒ½æœ‰è‡ªå·±çš„èŠ‚ç‚¹ï¼Œæ‰€ä»¥å®ƒä¼šæ ¹æ®ç”¨æˆ·çš„ipå»ç­›é€‰ä¸€ä¸ªç¦»ç”¨æˆ·æ¯”è¾ƒè¿‘èŠ‚ç‚¹ipè¿”å›ï¼Œè¿™äº›èŠ‚ç‚¹è¢«ç§°ä½œ**è¾¹ç¼˜èŠ‚ç‚¹** ï¼Œè¿™æ ·ç”¨æˆ·çš„è¯·æ±‚å°±èƒ½å°±è¿‘è®¿é—®äº†ã€‚


## æœ¬åœ°æ­å»ºä¸€ä¸ªcdn

æˆ‘ä»¬æŠŠä¸Šé¢çš„è¯·æ±‚è¿‡ç¨‹ä¸cdnæ¶æ„åœ¨æœ¬åœ°æ¨¡æ‹Ÿä¸‹ï¼ŒæŠŠè‡ªå·±æƒ³è±¡æˆä¸€ä¸ªcdnæœåŠ¡å•†ï¼Œæˆ‘ä»¬å°†ä¼šæ­å»ºcdnçš„åŸŸåè°ƒåº¦ä¸­å¿ƒï¼Œå’Œè¾¹ç¼˜èŠ‚ç‚¹ï¼Œç„¶åå…è®¸ç”¨æˆ·æä¾›åŠ é€ŸåŸŸåå’Œå›æºæœåŠ¡å™¨ç»™æˆ‘è¿›è¡Œé…ç½®ã€‚


### æ­å»ºdnsæœåŠ¡å™¨
æˆ‘ä»¬å…ˆæ¥æ­å»ºä¸€ä¸ªdnsæœåŠ¡å™¨ï¼Œå› ä¸ºæ— è®ºæ˜¯cdnè¿˜æ˜¯ç”¨æˆ·æœ¬èº«éƒ½éœ€è¦è¿›è¡Œä¸€äº›dnsåŸŸåé…ç½®ï¼Œä½ å¯ä»¥æŠŠå½“å‰è¿™ä¸ªdnsæœåŠ¡å™¨æƒ³è±¡æˆç¬¬ä¸‰æ–¹dnsè¿è¥å•†ã€‚

æˆ‘ä»¬ç”¨dnsmasqåœ¨æœ¬åœ°è¿›è¡ŒdnsæœåŠ¡å™¨çš„æ­å»ºï¼Œæˆ‘æœ¬åœ°æœºå™¨ç”¨çš„macï¼Œå®‰è£…å‘½ä»¤å¦‚ä¸‹:
```shell
brew install  dnsmasq

==> Dependencies
Build: pkg-config âœ”
==> Caveats
To start dnsmasq now and restart at startup:
  sudo brew services start dnsmasq
Or, if you don't want/need a background service you can just run:
  /opt/homebrew/opt/dnsmasq/sbin/dnsmasq --keep-in-foreground -C /opt/homebrew/etc/dnsmasq.conf -7 /opt/homebrew/etc/dnsmasq.d,*.conf
==> Analytics
install: 0 (30 days), 0 (90 days), 0 (365 days)
install-on-request: 0 (30 days), 0 (90 days), 0 (365 days
```
æ¥ç€éœ€è¦å¯¹å…¶é…ç½®æ–‡ä»¶è¿›è¡Œä¿®æ”¹ï¼Œé…ç½®ä¸Šæ¸¸æœåŠ¡å™¨ï¼Œä»¥åŠé…ç½®å½“å‰dnsæœåŠ¡å™¨èƒ½å¤Ÿè§£æçš„åŸŸå

ä»å®‰è£…çš„ä¿¡æ¯å¯ä»¥çœ‹å‡ºï¼Œå…¶é…ç½®æ–‡ä»¶æ˜¯åœ¨/opt/homebrew/etc/dnsmasq.conf è¿™ä¸ªä½ç½®ï¼Œè¿™é‡Œæˆ‘ç›´æ¥ç»™å‡ºæˆ‘çš„é…ç½®ä¿¡æ¯
```shell
# é…ç½®ä¸Šè¡ŒDNSï¼Œå¯¹åº”no-resolv
resolv-file=/Users/xiongchuanhong/dnsmasq.conf
# è¿è¡Œè¿›ç¨‹ä»¥å“ªä¸ªç”¨æˆ·èº«ä»½è¿è¡Œï¼Œç›´æ¥ç”¨rootï¼Œå› ä¸ºdnsmasqçš„é…ç½®æ¶‰åŠåˆ°æƒé™é—®é¢˜
user=root
# é…ç½®dnsmqsqè¿è¡Œæ—¥å¿—ï¼Œå¯¹æ’é”™å¾ˆé‡è¦
log-facility=/Users/xiongchuanhong/logs/dnsmasq.log
# resolv.confå†…çš„DNSå¯»å€ä¸¥æ ¼æŒ‰ç…§ä»ä¸Šåˆ°ä¸‹é¡ºåºæ‰§è¡Œï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢
strict-order
# DNSè§£æhostsæ—¶å¯¹åº”çš„hostsæ–‡ä»¶ï¼Œå¯¹åº”no-hosts
addn-hosts=/etc/hosts
cache-size=1024
# å¤šä¸ªIPç”¨é€—å·åˆ†éš”ï¼Œ192.168.x.xè¡¨ç¤ºæœ¬æœºçš„ipåœ°å€ï¼Œåªæœ‰127.0.0.1çš„æ—¶å€™è¡¨ç¤ºåªæœ‰æœ¬æœºå¯ä»¥è®¿é—®ã€‚
# é€šè¿‡è¿™ä¸ªè®¾ç½®å°±å¯ä»¥å®ç°åŒä¸€å±€åŸŸç½‘å†…çš„è®¾å¤‡ï¼Œé€šè¿‡æŠŠç½‘ç»œDNSè®¾ç½®ä¸ºæœ¬æœºIPä»è€Œå®ç°å±€åŸŸç½‘èŒƒå›´å†…çš„DNSæ³›è§£æ(æ³¨ï¼šæ— æ•ˆIPæœ‰å¯èƒ½å¯¼è‡³æœåŠ¡æ— æ³•å¯åŠ¨ï¼‰192.168.17.150 æ˜¯æˆ‘æœ¬åœ°æœºå™¨å†…ç½‘ip
listen-address=127.0.0.1,192.168.17.150
# ç›¸å½“äºnsè®°å½•ï¼Œc.lanpangziçš„åŸŸåä»¥åŠå…¶å­åŸŸåéƒ½ä¼šç”±æœ¬åœ°1053ç«¯å£çš„è¿›ç¨‹å»è¿›è¡Œè§£æ
server=/c.lanpangzi/127.0.0.1#1053
# cnameè®°å½•ï¼Œè®¿é—®web.cdn.test çš„åŸŸåéƒ½ä¼šæŒ‡å‘web.cdn.test.c.lanpangzi 
cname=web.cdn.test,web.cdn.test.c.lanpangzi
# é‡è¦ï¼ï¼è¿™ä¸€è¡Œå°±æ˜¯ä½ æƒ³è¦æ³›è§£æçš„åŸŸåé…ç½®.
#address=/hello.me/127.0.0.1
```

ä¸Šé¢resolv-file æ‰€æŒ‡å‘çš„æ–‡ä»¶æ˜¯è¦é…ç½®çš„ä¸Šæ¸¸dnsæœåŠ¡å™¨,/Users/xiongchuanhong/dnsmasq.confé…ç½®å¦‚ä¸‹:
```shell
(base) âœ  ~ cat /Users/xiongchuanhong/dnsmasq.conf
 nameserver 8.8.8.8
```

å½“æœ¬åœ°è§£æä¸äº†åŸŸåï¼Œé‚£ä¹ˆdnsmasqä¼šè¯¢é—®å®ƒçš„ä¸Šæ¸¸dnsæœåŠ¡å™¨ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠå®ƒé…ç½®æˆè°·æ­Œçš„åŸŸåè§£æç³»ç»Ÿã€‚

> ğŸ“¢ğŸ“¢æ³¨æ„Users/xiongchuanhong/dnsmasq.confå’ŒUsers/xiongchuanhong/logs/dnsmasq.logæ–‡ä»¶éƒ½éœ€è¦ç”¨rootç”¨æˆ·å»åˆ›å»ºï¼Œä¸ç„¶åˆ°æ—¶å€™è¿è¡Œä¼šæŠ¥æƒé™é”™è¯¯ã€‚

æ¥ç€å¯åŠ¨dnsmasqæœåŠ¡
```shell
sudo brew services start  dnsmasq
```

ç„¶åå†æŠŠæœºå™¨çš„dnsæœåŠ¡å™¨ipæ”¹æˆ127.0.0.1

![1791686894116_.pic.jpg](https://s2.loli.net/2023/06/16/HwByU27vuMqVxmI.jpg)

![1801686894126_.pic.jpg](https://s2.loli.net/2023/06/16/9NifkRHBvTJ7u6U.jpg)

æ¥ç€æµ‹è¯•ä¸‹ä¿®æ”¹åçš„ç½‘ç»œè®¿é—®æœ‰æ²¡æœ‰é—®é¢˜
```shell
(base) âœ  ~ ping www.baidu.com
PING www.a.shifen.com (14.119.104.189): 56 data bytes
64 bytes from 14.119.104.189: icmp_seq=0 ttl=54 time=36.413 ms
64 bytes from 14.119.104.189: icmp_seq=1 ttl=54 time=11.351 ms
64 bytes from 14.119.104.189: icmp_seq=2 ttl=54 time=11.339 ms
64 bytes from 14.119.104.189: icmp_seq=3 ttl=54 time=16.660 ms
```

åŸŸåè§£ææ­£å¸¸ï¼Œæ¥ç€è¿›è¡Œä¸‹é¢çš„æ­¥éª¤ã€‚
### æ­å»ºå›æºæœåŠ¡å™¨å’Œcdnè¾¹ç¼˜èŠ‚ç‚¹

æ¥ç€æˆ‘ä»¬æ¥å¿«é€Ÿæ­å»ºä¸‹å›æºæœåŠ¡å™¨å’Œcdnçš„è¾¹ç¼˜èŠ‚ç‚¹ï¼Œè¿™é‡Œæˆ‘æ˜¯ç›´æ¥å€Ÿç”¨äº†nginxæ¥è¿›è¡Œæ­å»ºï¼Œå› ä¸ºnginxå¯ä»¥ç”¨ä½œé™æ€èµ„æºæœåŠ¡å™¨ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥å¯åŠ¨ä¸€ä¸ªnginxå®¹å™¨æŠŠå®ƒä½œä¸ºæºæœåŠ¡å™¨ï¼Œæä¾›å›¾ç‰‡èµ„æºçš„è®¿é—®ã€‚ å¹¶ä¸”nginxä¹Ÿèƒ½æä¾›ç¼“å­˜æœåŠ¡ï¼Œè¿™ä¹Ÿåˆšå¥½ç¬¦åˆè¾¹ç¼˜èŠ‚ç‚¹ç¼“å­˜èµ„æºçš„éœ€æ±‚ã€‚ç”±äºè¾¹ç¼˜èŠ‚ç‚¹éœ€è¦å›æºåˆ°æºæœåŠ¡å™¨ï¼Œä½†æ˜¯å®¹å™¨çš„ipåˆæ˜¯ä¸å›ºå®šçš„ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ç›´æ¥ç”¨docker-composeå¯¹è¿™ä¸¤ä¸ªå®¹å™¨è¿›è¡Œäº†ç¼–æ’ï¼Œè¿™æ ·åœ¨å†™nginxé…ç½®æ–‡ä»¶çš„æ—¶å€™ï¼Œä¾¿å¯ä»¥ç”¨å®¹å™¨åä»£æ›¿ipäº†ã€‚

#### docker-compose.yamlé…ç½®æ–‡ä»¶

```shell
version: "3"  
services:  
  sourceserver:  
    image: nginx:latest  
    container_name: source-server  
    hostname: source-server  
    ports:  
      - '8080:80'  
    volumes:  
      - ./sourceserver/nginx.conf:/etc/nginx/nginx.conf  
      - ./sourceserver/logs:/var/log/nginx  
      - ./sourceserver/imgs:/imgs  
  
  edgenode:  
    image: nginx:latest  
    container_name: edgenode  
    hostname: edgenode  
    ports:  
      - '80:80'  
    volumes:  
      - ./edgenode/nginx.conf:/etc/nginx/nginx.conf  
      - ./edgenode/logs:/var/log/nginx  
      - ./edgenode/cache:/cache
```


#### æºç«™æœåŠ¡å™¨çš„nginxé…ç½®

```shell
  
worker_processes  1;  
error_log   /var/log/nginx/error.log;  
events {  
    worker_connections  1024;  
}  
http {  
    default_type  application/octet-stream;  
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '  
                      '$status $body_bytes_sent "$http_referer" '  
                      '"$http_user_agent" "$http_x_forwarded_for"';  
    # é™æ€èµ„æºé…ç½®  
    server {  
        listen       80;  
        access_log  /var/log/nginx/access.log  main ;  
        location /static {  
            alias   /imgs;  
        }  
    }  
}
```


#### è¾¹ç¼˜èŠ‚ç‚¹çš„nginxé…ç½®

åœ¨serveræ¨¡å—é‡Œï¼Œæˆ‘ä»¬é…ç½® proxy_pass è½¬å‘è·¯å¾„æ—¶ï¼Œç›´æ¥ç”¨æºæœåŠ¡å™¨çš„å®¹å™¨åä»£æ›¿äº†ipï¼Œhttp://sourceserverã€‚å½“æœ¬åœ°æ²¡æœ‰ç¼“å­˜æ—¶ï¼Œå°±ä¼šé€šè¿‡http://sourceserver è®¿é—®æºç«™æœåŠ¡å™¨ã€‚

> ğŸ“¢ğŸ“¢æ³¨æ„ä¸‹ï¼Œåœ¨çœŸå®ç¯å¢ƒé‡Œï¼Œè¾¹ç¼˜èŠ‚ç‚¹çš„æºç«™æœåŠ¡å™¨åå’ŒåŠ é€ŸåŸŸåè‚¯å®šä¸æ˜¯å†™æ­»çš„ï¼Œæ˜¯ç”¨æˆ·é…ç½®åœ¨cdnæœåŠ¡å•†çš„æ•°æ®åº“é‡Œï¼Œç„¶åè¾¹ç¼˜èŠ‚ç‚¹å†ä»æœåŠ¡å™¨é‡Œè¯»å–çš„ã€‚
>
> å¹¶ä¸”è¾¹ç¼˜èŠ‚ç‚¹è¦æ±‚åªæœ‰ç”¨æˆ·çš„åŠ é€ŸåŸŸåæ‰èƒ½è®¿é—®ï¼Œæ‰€ä»¥åœ¨è½¬å‘è¯·æ±‚å‰è¿˜è¦åˆ¤æ–­ä¸‹åŸŸåæ˜¯ä¸æ˜¯ç”¨æˆ·çš„åŠ é€ŸåŸŸåã€‚

```shell
worker_processes  1;  
error_log   /var/log/nginx/error.log;  
events {  
    worker_connections  1024;  
}  
http {  
    log_format  main  '$host- $remote_addr - $remote_user [$time_local] "$request" '  
                      '$status $body_bytes_sent "$http_referer" '  
                      '"$http_user_agent" "$http_x_forwarded_for"';  
      proxy_cache_path  /cache levels=1:2 keys_zone=lanpangzi-cache:20m max_size=50g inactive=168h;  
      proxy_cache lanpangzi-cache;  
      proxy_cache_valid 168h;  
  server {  
      root /static;  
      listen       80;  
      location ~* \.(css|js|png|jpg|jpeg|gif|gz|svg|mp4|ogg|ogv|webm|htc|xml|woff)$ {  
        if ($host != 'web.cdn.test')  {  
             return 403;  
           }  
      access_log  /var/log/nginx/access.log  main;  
      proxy_pass http://sourceserver;  
    }  
  }  
}
```

è¿™æ ·å°±å¿«é€Ÿæ­å»ºå¥½äº†æºæœåŠ¡å™¨å’Œè¾¹ç¼˜èŠ‚ç‚¹ï¼Œæˆ‘ä»¬åˆ°æ—¶å€™ç›´æ¥ç”¨docker-compose upå‘½ä»¤ä¾¿å¯ä»¥å¯åŠ¨å®¹å™¨ï¼Œè¾¹ç¼˜èŠ‚ç‚¹ç›‘å¬äº†æœ¬åœ°80ç«¯å£ã€‚

### æ­å»ºcdnçš„åŸŸåè°ƒåº¦ç³»ç»Ÿ

æœ€åï¼Œæˆ‘ä»¬æ¥æ­å»ºä¸‹cdnçš„åŸŸåè°ƒåº¦ç³»ç»Ÿï¼Œé˜²æ­¢é—å¿˜ï¼Œæˆ‘ä»¬å†æ¥ä¸²è”ä¸‹é…ç½®cdnçš„è¿‡ç¨‹ï¼Œç”¨æˆ·æ‹¥æœ‰è‡ªå·±çš„åŠ é€ŸåŸŸåå’Œæºç«™æœåŠ¡å™¨ï¼Œå¹¶ä¸”å°†è¿™ä¸¤ä¸ªå‘Šè¯‰äº†cdnæœåŠ¡å•†ï¼ŒcdnæœåŠ¡å•†å°±äº§ç”Ÿä¸€ä¸ªæ–°åŸŸåï¼Œè¿™ä¸ªæ–°åŸŸåéœ€è¦é…ç½®ä¸ºcnameè®°å½•ï¼Œä¸ç”¨æˆ·çš„åŠ é€ŸåŸŸåå…³è”èµ·æ¥ï¼Œè¿™æ¡cnameè®°å½•ä½œæˆ‘ä»¬åœ¨æ­å»ºdnsmasqæ—¶å·²ç»å†™æ­»åœ¨äº†é…ç½®æ–‡ä»¶é‡Œã€‚
```shell
cname=web.cdn.test,web.cdn.test.c.lanpangzi
```

> ğŸ“¢ğŸ“¢æ³¨æ„ï¼Œç°å®ä¸­ï¼ŒcdnæœåŠ¡å•†æ–°ç”Ÿæˆçš„åŸŸåéœ€è¦ç”¨æˆ·è‡ªå·±å»å…¶dnsæœåŠ¡å•†é‚£é‡Œå»è¿›è¡Œé…ç½®

åŒæ—¶ï¼ŒcdnæœåŠ¡å•†ç”Ÿæˆçš„æ–°åŸŸåè§£æå› ä¸ºé…ç½®çš„**ns**è®°å½•ï¼Œå·²ç»å°†æ–°çš„è¿™ä¸ªåŸŸåè§£ææŒ‡å‘äº†è‡ªå·±çš„dnsåŸŸåè°ƒåº¦ç³»ç»Ÿï¼Œåˆ°æ—¶å€™é€šè¿‡è¿™ä¸ªç³»ç»Ÿä¾¿å¯ä»¥è¿”å›ç»™ç”¨æˆ·æœ€è¿‘çš„è¾¹ç¼˜èŠ‚ç‚¹çš„ipã€‚

è¿™æ¡nsè®°å½•æˆ‘ä»¬ä¹Ÿå†™æ­»åœ¨äº†dnsmasqçš„é…ç½®æ–‡ä»¶é‡Œã€‚
```shell
server=/c.lanpangzi/127.0.0.1#1053
```

åˆ°æ—¶å€™æˆ‘ä»¬æœ¬åœ°ä¼šåœ¨1053ç«¯å£å¯åŠ¨ä¸€ä¸ªè¿›ç¨‹ç”¨äºå¯¹c.lanpangziåŸŸåè¿›è¡Œè§£æã€‚

æ¥ç€æ¥æ€è€ƒğŸ¤”ä¸‹å¦‚ä½•å†™ä¸€ä¸ªåŸŸåè°ƒåº¦ç³»ç»Ÿï¼Œæˆ‘ä»¬çš„æœåŠ¡é€šä¿¡éœ€è¦éµå¾ªdnsåè®®ï¼Œç”±äºæˆ‘ä»¬çš„è¾¹ç¼˜èŠ‚ç‚¹æ˜¯éƒ¨ç½²åˆ°æœ¬åœ°ï¼Œipæ˜¯127.0.0.1ï¼Œæ‰€ä»¥å½“è§£æåˆ°è¯·æ±‚æ—¶è¦è¯¢é—®web.cdn.test.c.lanpangziè¿™ä¸ªåŸŸåæ—¶ï¼Œç›´æ¥è¿”å›æœ¬åœ°è¿™ä¸ªipå³å¯ã€‚ é‚£å¯¹äºå…¶ä»–åŸŸåå¦‚ä½•å¤„ç†ï¼Œå½“ç„¶æ˜¯ç›´æ¥ä¸¢æ‰ï¼Œå› ä¸ºcdnçš„åŸŸåè°ƒåº¦ç³»ç»Ÿï¼Œåªæä¾›å¯¹è‡ªå·±cdnæœåŠ¡å•†ç”Ÿæˆçš„åŸŸåè¿›è¡Œè§£æã€‚

ç”¨golangç®€å•å®ç°ä»£ç å¦‚ä¸‹:

è¿™é‡Œæˆ‘ç›´æ¥åœ¨ä»£ç é‡Œå°†cnameåŸŸåä»¥åŠè¾¹ç¼˜èŠ‚ç‚¹çš„ipå†™æ­»åœ¨ä»£ç é‡Œäº†(é‡åœ¨æ¨¡æ‹Ÿcdnè¯·æ±‚è¿‡ç¨‹)ï¼Œåªè¦æ˜¯web.cdn.test.c.lanpangzi.è¿™ä¸ªåŸŸåå°±è¿”å›è¾¹ç¼˜èŠ‚ç‚¹ipï¼Œç”±äºæˆ‘ä»¬éƒ½æ˜¯éƒ¨ç½²åˆ°æœ¬åœ°ï¼Œæ‰€ä»¥è¾¹ç¼˜èŠ‚ç‚¹ipå°±æ˜¯127.0.0.1äº†ï¼Œdnsçš„è§£æç”¨äº†ç°æˆçš„golangåº“ã€‚
```go
import (  
   "github.com/miekg/dns"  
   "log"   "net")  
  
var cdnConfig = map[string]string{  
   "web.cdn.test.c.lanpangzi.": "127.0.0.1",  
}  
  
// å¤„ç†åˆ°æ¥çš„è¯·æ±‚  
func handler(writer dns.ResponseWriter, req *dns.Msg) {  
   var resp dns.Msg  
   resp.SetReply(req) // åˆ›å»ºåº”ç­”  
   for _, question := range req.Question {  
      ip := cdnConfig[question.Name]  
      if len(ip) == 0 {  
         return  
      }  
      recordA := dns.A{  
         Hdr: dns.RR_Header{  
            Name:   question.Name,  
            Rrtype: dns.TypeA,  
            Class:  dns.ClassINET,  
            Ttl:    100,  
         },  
         A: net.ParseIP(ip).To4(), // å…¨éƒ¨è§£æä¸º127.0.0.1  
      }  
      resp.Answer = append(resp.Answer, &recordA) // å†™å…¥åº”ç­”  
   }  
   err := writer.WriteMsg(&resp) // å›å†™ä¿¡æ¯  
   if err != nil {  
      return  
   }  
}  
  
func main() {  
   dns.HandleFunc(".", handler)                   // ç»‘å®šå‡½æ•°  
   err := dns.ListenAndServe(":1053", "udp", nil) // å¯åŠ¨  
   if err != nil {  
      log.Println(err)  
   }  
}
```


### æµ‹è¯•
æ¥ç€ï¼Œæˆ‘ä»¬å°±å¯ä»¥æµ‹è¯•ä¸‹ç°åœ¨æ­å»ºçš„è¿™ä¸ªcdnç³»ç»Ÿäº†ï¼Œè™½ç„¶æˆ‘ä»¬å°†å¾ˆå¤šé…ç½®ä¿¡æ¯éƒ½å†™æ­»åœ¨äº†ä»£ç é‡Œï¼Œä½†ä½ å¯ä»¥å‡è£…ä»–ä»¬æ˜¯è‡ªåŠ¨é…ç½®ä¸Šçš„ğŸ¶ã€‚

æ¥çœ‹ä¸‹ç°åœ¨çš„ä»£ç æ¡†æ¶.

![Pasted image 20230616164830.png](https://s2.loli.net/2023/06/16/x7yatZ5C49UOgud.jpg)

cnddnså°±æ˜¯æ¨¡æ‹Ÿçš„cdnè°ƒåº¦ä¸­å¿ƒäº†ï¼Œedgenodeå’Œsourceserveræ”¾çš„éƒ½æ˜¯nginxçš„é…ç½®æ–‡ä»¶ï¼Œdocker-compose.yamlåˆ°æ—¶å€™ä¼šå¯åŠ¨ä»–ä»¬ã€‚

#### å¯åŠ¨æºç«™æœåŠ¡å™¨ï¼Œè¾¹ç¼˜èŠ‚ç‚¹
```shell
(base) âœ  cdndemo git:(master) âœ— docker-compose up 
Starting edgenode      ... done
Starting source-server ... done
Attaching to edgenode, source-server
source-server   | /docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration
source-server   | /docker-entrypoint.sh: Looking for shell scripts in /docker-entrypoint.d/
source-server   | /docker-entrypoint.sh: Launching /docker-entrypoint.d/10-listen-on-ipv6-by-default.sh

```

#### å¯åŠ¨cdnè°ƒåº¦ä¸­å¿ƒ
```shell
(base) âœ  cdndemo git:(master) âœ— cd cdndns            
(base) âœ  cdndns git:(master) âœ— go run main.go  
```

#### æµ‹è¯•è®¿é—®

æˆ‘ä»¬å·²ç»æŠŠæœ¬åœ°æœºå™¨çš„dnsæœåŠ¡å™¨æ”¹ä¸ºdnsmasqäº†ï¼Œæ¥ç€å°±æ˜¯æœ€åæµ‹è¯•ä¸‹è®¿é—®æ˜¯å¦ç”Ÿæ•ˆã€‚

æˆ‘åœ¨æµè§ˆå™¨è¿ç»­è¿›è¡Œäº†ä¸¤æ¬¡è®¿é—®
```shell
http://web.cdn.test/static/1781686486866_.pic.jpg
```

æ¥ç€æŸ¥çœ‹ä¸‹nginxçš„access.log

è¾¹ç¼˜èŠ‚ç‚¹çš„æ—¥å¿—
```shell
web.cdn.test- 172.22.0.1 - - [16/Jun/2023:08:53:12 +0000] "GET /static/1781686486866_.pic.jpg HTTP/1.1" 304 0 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36" "-"  
web.cdn.test- 172.22.0.1 - - [16/Jun/2023:08:53:31 +0000] "GET /static/1781686486866_.pic.jpg HTTP/1.1" 304 0 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36" "-"
```

æºç«™æœåŠ¡å™¨æ—¥å¿—
```shell
sourceserver- 172.22.0.3 - - [16/Jun/2023:08:53:12 +0000] "GET /static/1781686486866_.pic.jpg HTTP/1.0" 200 265084 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36" "-"
```

å¯ä»¥çœ‹è§å½“ç¬¬äºŒæ¬¡è®¿é—®çš„æ—¶å€™ï¼Œæºç«™æœåŠ¡å™¨ä¸Šæ²¡æœ‰æ—¥å¿—äº†ï¼Œè¾¹ç¼˜èŠ‚ç‚¹ä»ç„¶æœ‰è®¿é—®æ—¥å¿—ï¼Œè¯´æ˜ç¬¬äºŒæ¬¡è®¿é—®å·²ç»ç›´æ¥ä»è¾¹ç¼˜èŠ‚ç‚¹è¯»å–åˆ°äº†å›¾ç‰‡ä¿¡æ¯ã€‚

è¿˜æ˜¯å¼ºçƒˆå»ºè®®æŠŠæºç ä¸‹ä¸‹æ¥äº²è‡ªå®éªŒä¸€éï¼Œä½ ä¼šæ›´åŠ æ·±åˆ»ğŸ‘ğŸ»ã€‚


